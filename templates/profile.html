<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile - ToolTrack</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared_navbar.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <div class="logo navbar-brand">
                    <a href="{{ url_for('home') }}">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" />
                    </a>
                </div>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav menu mx-auto">
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('equipment') }}">Equipment</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('list') }}">List</a></li>
                    </ul>
                    
                    {% if session.username %}
                    <div class="user-section d-flex align-items-center">
                        <div class="user me-3">
                            <a href="{{ url_for('profile') }}" class="d-flex align-items-center text-decoration-none">
                                <img src="{{ url_for('static', filename='images/profile.png') }}" alt="Profile" class="profile-icon" />
                                <span class="username ms-2">{{ session.username }}</span>
                            </a>
                        </div>
                        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-light logout-button">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </a>
                    </div>
                    {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-sm btn-light login-button">
                        <i class="fas fa-sign-in-alt me-1"></i> Login
                    </a>
                    {% endif %}
                </div>
            </div>
        </nav>
    </header>
    
    <main class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
                    <div class="profile-card">
                        <div class="profile-header">
                            <h1 class="display-5 fw-bold">My Profile</h1>
                            <div class="profile-image-container">
                                <img src="{{ user_info.profile_image }}" alt="Profile Picture" class="profile-image">
                                <div class="edit-profile-image">
                                    <i class="fas fa-camera"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-content mt-4">
                            <div class="table-responsive">
                                <table class="profile-table">
                                    <tr>
                                        <th><i class="fas fa-user me-2"></i>Username</th>
                                        <td>{{ user_info.username }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-id-card me-2"></i>Full Name</th>
                                        <td>{{ user_info.fullname }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-envelope me-2"></i>Email</th>
                                        <td>{{ user_info.email }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-phone me-2"></i>Phone</th>
                                        <td>{{ user_info.phone }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-graduation-cap me-2"></i>Faculty</th>
                                        <td>{{ user_info.faculty }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-id-badge me-2"></i>Student ID</th>
                                        <td>{{ user_info.student_id }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-users me-2"></i>Club Member</th>
                                        <td>{{ user_info.club_member }}</td>
                                    </tr>
                                    <tr>
                                        <th><i class="fas fa-birthday-cake me-2"></i>Date of Birth</th>
                                        <td>{{ user_info.dob }}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="profile-actions mt-4 text-center">
                                <button class="btn edit-profile-btn me-2">
                                    <i class="fas fa-edit me-2"></i>Edit Profile
                                </button>
                                <button class="btn change-password-btn">
                                    <i class="fas fa-key me-2"></i>Change Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
        // Edit profile image functionality
        document.querySelector('.edit-profile-image').addEventListener('click', function() {
            Swal.fire({
                title: 'อัพเดทรูปโปรไฟล์',
                html: `
                    <div class="upload-preview mb-3">
                        <img id="preview-image" src="{{ user_info.profile_image }}" style="max-width: 200px; max-height: 200px; border-radius: 50%;">
                    </div>
                    <input type="file" id="profile-upload" class="swal2-input" accept="image/*" style="display: none;">
                    <label for="profile-upload" class="btn" style="background-color: #91766E; color: white;">
                        <i class="fas fa-upload me-2"></i>เลือกรูปภาพ
                    </label>
                `,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#91766E',
                cancelButtonColor: '#6c757d',
                didOpen: () => {
                    const fileInput = document.getElementById('profile-upload');
                    const previewImage = document.getElementById('preview-image');
                    
                    fileInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // ตรวจสอบนามสกุลไฟล์
                            const validExtensions = ['jpg', 'jpeg', 'png', 'gif'];
                            const fileExtension = file.name.split('.').pop().toLowerCase();
                            
                            if (!validExtensions.includes(fileExtension)) {
                                Swal.showValidationMessage(
                                    `กรุณาเลือกไฟล์รูปภาพเท่านั้น (${validExtensions.join(', ')})`
                                );
                                return;
                            }
                            
                            // ตรวจสอบขนาดไฟล์ (ไม่เกิน 2MB)
                            if (file.size > 2 * 1024 * 1024) {
                                Swal.showValidationMessage(
                                    'ขนาดไฟล์ต้องไม่เกิน 2MB'
                                );
                                return;
                            }
                            
                            // แสดงตัวอย่างรูปภาพ
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                previewImage.src = e.target.result;
                            }
                            reader.readAsDataURL(file);
                        }
                    });
                },
                preConfirm: () => {
                    const fileInput = document.getElementById('profile-upload');
                    
                    if (!fileInput.files[0]) {
                        Swal.showValidationMessage('กรุณาเลือกรูปภาพ');
                        return false;
                    }
                    
                    // สร้าง FormData สำหรับอัพโหลดไฟล์
                    const formData = new FormData();
                    formData.append('profile_image', fileInput.files[0]);
                    
                    // ส่งข้อมูลไปยัง API
                    return fetch('{{ url_for("update_profile_image") }}', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('เกิดข้อผิดพลาดในการอัพโหลดรูปภาพ');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(
                            `อัพโหลดล้มเหลว: ${error}`
                        );
                    });
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    // อัพเดทรูปภาพโปรไฟล์บนหน้าเว็บ
                    const profileImages = document.querySelectorAll('.profile-image');
                    profileImages.forEach(img => {
                        img.src = result.value.image_url + '?t=' + new Date().getTime();
                    });
                    
                    Swal.fire({
                        title: 'อัพเดทสำเร็จ!',
                        text: 'รูปโปรไฟล์ของคุณได้รับการอัพเดทแล้ว',
                        icon: 'success',
                        confirmButtonColor: '#91766E'
                    });
                }
            });
        });
            
            // Edit profile button functionality
            document.querySelector('.edit-profile-btn').addEventListener('click', function() {
                Swal.fire({
                    title: 'Edit Profile',
                    text: 'This feature is coming soon!',
                    icon: 'info',
                    confirmButtonColor: '#91766E'
                });
            });
            
            // Change password button functionality
            document.querySelector('.change-password-btn').addEventListener('click', function() {
                window.location.href = "{{ url_for('change_password') }}";
            });
        });
    </script>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <script>
          if ('{{ category }}' == 'success') {
            Swal.fire({
              icon: 'success',
              title: '{{ message }}',
              text: 'Welcome to ToolTrack!',
              showCancelButton: true,
              confirmButtonText: 'Go to Equipment',
              cancelButtonText: 'Stay here',
              reverseButtons: true,
              confirmButtonColor: '#91766E',
              cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{{ url_for('equipment') }}";
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    Swal.close();
                }
            });
          } else if ('{{ category }}' == 'error') {
              Swal.fire({
                  icon: 'error',
                  title: '{{ message }}',
                  showConfirmButton: true,
                  confirmButtonColor: '#91766E'
              })
          }
        </script>
        {% endfor %}
    {% endif %}
    {% endwith %}
</body>
</html>